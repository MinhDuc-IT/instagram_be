generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                         Int                  @id @default(autoincrement())
  userName                                   String
  email                                      String               @unique
  password                                   String
  gender                                     Int?
  phone                                      String?
  role                                       String               @default("USER")
  authId                                     String?
  trialExpiresAt                             DateTime?
  isVerified                                 Boolean              @default(false)
  lastLogin                                  DateTime?
  /// üîç Audit fields
  createdAt                                  DateTime             @default(now())
  createdBy                                  String?
  modifiedAt                                 DateTime?
  modifiedBy                                 String?
  deleted                                    Boolean              @default(false)
  deletedAt                                  DateTime?
  deletedBy                                  String?
  fullName                                   String?
  avatar                                     String?
  loginType                                  String               @default("LOCAL")
  loginToken                                 String?              @unique
  Comment                                    Comment[]
  CommentLike                                CommentLike[]
  ConversationMember                         ConversationMember[]
  Follow_Follow_followerIdToUser             Follow[]             @relation("Follow_followerIdToUser")
  Follow_Follow_followingIdToUser            Follow[]             @relation("Follow_followingIdToUser")
  Message                                    Message[]
  MessageRead                                MessageRead[]
  Notification_Notification_receiverIdToUser Notification[]       @relation("Notification_receiverIdToUser")
  Notification_Notification_senderIdToUser   Notification[]       @relation("Notification_senderIdToUser")
  Post                                       Post[]
  PostLike                                   PostLike[]
  PostSave                                   PostSave[]
  Story                                      Story[]
  StoryLike                                  StoryLike[]
  StoryView                                  StoryView[]
  UserDevice                                 UserDevice[]
  UserToken                                  UserToken[]
  UserVerification                           UserVerification[]
}

model UserDevice {
  id           Int         @id @default(autoincrement())
  userId       Int
  deviceName   String
  userAgent    String
  deviceType   String
  ipAddress    String
  location     String?
  refreshToken String
  lastActive   DateTime    @default(now())
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokens       UserToken[]

  @@index([userId])
  @@map("user_devices")
}

model UserToken {
  id                 Int        @id @default(autoincrement())
  userId             Int
  deviceId           Int
  refreshToken       String
  refreshTokenFamily String
  expiresAt          DateTime
  invalidated        Boolean    @default(false)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  device             UserDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, deviceId])
  @@index([refreshTokenFamily])
  @@map("user_tokens")
}

model UserVerification {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_verifications")
}

model BackgroundJob {
  id           String    @id @default(cuid())
  type         String    @db.VarChar(50)
  fileName     String    @db.VarChar(255)
  status       String    @db.VarChar(50)
  result       Json?
  error        String?
  progress     Int       @default(0)
  retryCount   Int       @default(0)
  maxRetries   Int       @default(3)
  publicId     String?   @db.VarChar(255)
  url          String?
  secureUrl    String?
  fileSize     Int?
  format       String?   @db.VarChar(50)
  createdDate  DateTime  @default(now())
  createdBy    String?   @db.VarChar(255)
  modifiedDate DateTime  @updatedAt
  modifiedBy   String?   @db.VarChar(255)
  deleted      Boolean   @default(false)
  deletedDate  DateTime?
  deletedBy    String?   @db.VarChar(255)
  completedAt  DateTime?

  @@index([status])
  @@index([createdDate])
  @@index([type])
  @@index([deleted])
}

model UploadedAsset {
  id           String    @id @default(cuid())
  publicId     String    @unique @db.VarChar(255)
  type         String    @db.VarChar(50)
  fileName     String    @db.VarChar(255)
  url          String
  secureUrl    String
  format       String    @db.VarChar(50)
  width        Int?
  height       Int?
  duration     Float?
  fileSize     Int
  folder       String    @db.VarChar(255)
  tags         String
  createdDate  DateTime  @default(now())
  createdBy    String?   @db.VarChar(255)
  modifiedDate DateTime  @updatedAt
  modifiedBy   String?   @db.VarChar(255)
  deleted      Boolean   @default(false)
  deletedDate  DateTime?
  deletedBy    String?   @db.VarChar(255)
  postId       String?
  Post         Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  storyId      Int?
  Story        Story?    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  @@index([publicId])
  @@index([createdDate])
  @@index([type])
  @@index([deleted])
}

model Comment {
  id            Int           @id @default(autoincrement())
  userId        Int
  postId        String
  content       String
  parentId      Int?
  rootId        Int
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  Comment       Comment?      @relation("CommentToComment", fields: [parentId], references: [id])
  other_Comment Comment[]     @relation("CommentToComment")
  Post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  User          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  CommentLike   CommentLike[]
  Notification  Notification[]

  @@index([parentId])
  @@index([postId])
  @@index([userId])
  @@index([rootId, createdAt, id])
}

model CommentLike {
  id        Int      @id @default(autoincrement())
  actorId   Int
  commentId Int
  createdAt DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([actorId, commentId])
  @@index([commentId])
}

model Conversation {
  id                 Int                  @id @default(autoincrement())
  type               String               @default("private")
  name               String?
  avatar             String?
  hash               String?              @unique // Hash ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng c√≥ 2 conversation private gi·ªØa c√πng 2 user
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  ConversationMember ConversationMember[]
  Message            Message[]
}

model ConversationMember {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  joinedAt       DateTime     @default(now())
  leftedAt       DateTime?
  role           String?
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}


model PostSave {
  id        Int      @id @default(autoincrement())
  actorId   Int
  postId    String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([actorId, postId])
  @@index([postId])
}

model Follow {
  id                            Int      @id @default(autoincrement())
  followerId                    Int
  followingId                   Int
  createdAt                     DateTime @default(now())
  User_Follow_followerIdToUser  User     @relation("Follow_followerIdToUser", fields: [followerId], references: [id], onDelete: Cascade)
  User_Follow_followingIdToUser User     @relation("Follow_followingIdToUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Message {
  id             Int           @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String?
  messageType    String        @default("text")
  mediaUrl       String?
  replyToId      Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  Conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  Message        Message?      @relation("MessageToMessage", fields: [replyToId], references: [id])
  other_Message  Message[]     @relation("MessageToMessage")
  User           User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  MessageRead    MessageRead[]

  @@index([conversationId])
  @@index([replyToId])
  @@index([senderId])
}

model MessageRead {
  id        Int      @id @default(autoincrement())
  messageId Int
  actorId   Int
  readAt    DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, actorId])
  @@index([actorId])
}

model Notification {
  id                                 Int      @id @default(autoincrement())
  receiverId                         Int
  senderId                           Int
  type                               String   @db.VarChar(50)
  content                            String
  isRead                             Boolean   @default(false)
  createdAt                          DateTime  @default(now())
  postId                             String?
  commentId                          Int?
  User_Notification_receiverIdToUser User      @relation("Notification_receiverIdToUser", fields: [receiverId], references: [id], onDelete: Cascade)
  User_Notification_senderIdToUser   User      @relation("Notification_senderIdToUser", fields: [senderId], references: [id], onDelete: Cascade)
  Post                               Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  Comment                            Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([receiverId])
  @@index([senderId])
  @@index([type])
  @@index([postId])
  @@index([commentId])
}

model Post {
  id                 String          @id @default(cuid())
  userId             Int
  caption            String?
  location           String?
  visibility         String          @default("public")
  isLikesHidden      Boolean         @default(false)
  isCommentsDisabled Boolean         @default(false)
  createdDate        DateTime        @default(now())
  createdBy          String?         @db.VarChar(255)
  modifiedDate       DateTime        @updatedAt
  modifiedBy         String?         @db.VarChar(255)
  deleted            Boolean         @default(false)
  deletedDate        DateTime?
  deletedBy          String?         @db.VarChar(255)
  Comment            Comment[]
  User               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  PostLike           PostLike[]
  UploadedAsset      UploadedAsset[]
  postSaves          PostSave[]
  Notification       Notification[]
  Story              Story[]

  @@index([createdDate])
  @@index([deleted])
  @@index([userId])
}

model PostLike {
  id        Int      @id @default(autoincrement())
  actorId   Int
  postId    String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([actorId, postId])
  @@index([postId])
}

model Story {
  id        Int         @id @default(autoincrement())
  userId    Int
  mediaUrl  String
  type      String      @default("image") // image | video
  createdAt DateTime    @default(now())
  expiresAt DateTime
  User      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  StoryLike StoryLike[]
  StoryView StoryView[]
  Assets    UploadedAsset[]
  postId    String?
  Post      Post?       @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StoryLike {
  id        Int      @id @default(autoincrement())
  actorId   Int
  storyId   Int
  createdAt DateTime @default(now())
  User      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([actorId, storyId])
  @@index([storyId])
}

model StoryView {
  id       Int      @id @default(autoincrement())
  storyId  Int
  actorId  Int
  viewedAt DateTime @default(now())
  User     User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  Story    Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([actorId, storyId])
  @@index([storyId])
}
